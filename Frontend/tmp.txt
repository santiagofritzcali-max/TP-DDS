import React, { useState } from "react";
import { useLocation, useNavigate } from "react-router-dom";
import "../styles/reservarHabitacionStyle.css";
import { confirmarReserva } from "../services/reservaService";
import PopupCancelarReserva from "../components/PopupCancelarReserva";

const ROOM_TYPES_BY_NUMBER = {
  "101": "Individual Estándar",
  "102": "Individual Estándar",
  "201": "Doble Estándar",
  "203": "Doble Estándar",
  "301": "Doble Superior",
  "302": "Doble Superior",
  "404": "Superior Family",
  "500": "Suite",
};

const toIsoFromDMY = (dmy) => {
  if (!dmy) return "";
  const [dd, mm, yyyy] = dmy.split("/");
  return `${yyyy}-${mm}-${dd}`; 
};

const DatosReservaPage = () => {
  const location = useLocation();
  const navigate = useNavigate();

  
  const state = location.state || {};
  const {
    fechaDesde = "",
    fechaHasta = "",
    habitaciones = [],
  } = state;

  const [form, setForm] = useState({
    nombre: "",
    apellido: "",
    prefijo: "+54 9",
    telefono: "",
  });

  const [enviando, setEnviando] = useState(false);
  const [error, setError] = useState("");
  const [showCamposObligatoriosPopup, setShowCamposObligatoriosPopup] =
    useState(false);

  // errores por campo
  const [fieldErrors, setFieldErrors] = useState({
    nombre: "",
    apellido: "",
    telefono: "",
  });

  // pop-up de éxito
  const [showSuccessModal, setShowSuccessModal] = useState(false);

  const handleChange = (e) => {
    const { name } = e.target;
    let { value } = e.target;

    if (name === "nombre" || name === "apellido") {
      value = value.replace(/[^A-Za-zÁÉÍÓÚáéíóúÜüÑñ\s]/g, ""); // solo letras/espacios
    }

    if (name === "telefono") {
      value = value.replace(/\D/g, ""); // solo dígitos
    }

    setForm((prev) => ({ ...prev, [name]: value }));
  };

  const handleCancelar = () => {
    // Termina el CU y vuelve al menú principal
    navigate("/");
  };

  // ----------------- validación por campo -----------------
  const validarFormulario = () => {
    const soloLetras = /^[A-Za-zÁÉÍÓÚáéíóúÜüÑñ\s]+$/;
    const soloNumeros = /^[0-9]+$/;

    const errors = { nombre: "", apellido: "", telefono: "" };
    let esValido = true;

    // NOMBRE
    const nombreTrim = form.nombre.trim();
    if (!nombreTrim) {
      errors.nombre = "El campo Nombre es requerido.";
      esValido = false;
    } else if (!soloLetras.test(nombreTrim)) {
      errors.nombre =
        "El campo Nombre no puede contener números o caracteres especiales";
      esValido = false;
    }

    // APELLIDO
    const apellidoTrim = form.apellido.trim();
    if (!apellidoTrim) {
      errors.apellido = "El campo Apellido es requerido.";
      esValido = false;
    } else if (!soloLetras.test(apellidoTrim)) {
      errors.apellido =
        "El campo Apellido no puede contener números o caracteres especiales";
      esValido = false;
    }

    // TELÉFONO (solo dígitos)
    const telTrim = form.telefono.trim();
    if (!telTrim) {
      errors.telefono = "El campo Nro. Teléfono es requerido";
      esValido = false;
    } else if (!soloNumeros.test(telTrim)) {
      errors.telefono =
        "El campo Nro. Teléfono no puede contener letras o caracteres especiales";
      esValido = false;
    }

    setFieldErrors(errors);
    if (!esValido) {
      setShowCamposObligatoriosPopup(true);
    }
    return esValido;
  };

  // ----------------- confirmar reserva -----------------
  const handleConfirmar = async () => {
    setError("");

    const esFormValido = validarFormulario();
    if (!esFormValido) return;

    if (!habitaciones || habitaciones.length === 0) {
      setError("No hay habitaciones seleccionadas para confirmar.");
      return;
    }

    try {
      setEnviando(true);

      const telefonoCompleto = `${form.prefijo} ${form.telefono}`;

      const reservasPayload = habitaciones.map((h) => ({
        numeroHabitacion: h.nro,
        fechaInicio: toIsoFromDMY(h.fechaIngreso),
        fechaFin: toIsoFromDMY(h.fechaEgreso),
      }));

      const payload = {
        reservas: reservasPayload,
        nombre: form.nombre.trim(),
        apellido: form.apellido.trim(),
        telefono: telefonoCompleto.trim(),
      };

      console.log("Payload reserva:", payload);

      await confirmarReserva(payload);

      setFieldErrors({ nombre: "", apellido: "", telefono: "" });

      setShowSuccessModal(true);
    } catch (err) {
      console.error(err);
      setError("Ocurrió un error al confirmar la reserva.");
    } finally {
      setEnviando(false);
    }
  };

  const handleCerrarModalExito = () => {
    setShowSuccessModal(false);
    navigate("/");
  };

  return (
    <div className="reserva-page">
      {}
      <main className="datos-main-layout">
        {}
        <section className="datos-left-panel">
          <h2 className="section-title">Habitaciones seleccionadas</h2>

          <div className="selected-rooms-list">
            {!habitaciones || habitaciones.length === 0 ? (
              <p className="text-empty-right">
                No hay habitaciones seleccionadas.
              </p>
            ) : (
              habitaciones.map((item, idx) => {
                const nroCompleto = String(item.nro);
                const nroSimple = nroCompleto.includes("-")
                  ? nroCompleto.split("-")[1]
                  : nroCompleto;

                const tipoHab =
                  ROOM_TYPES_BY_NUMBER[nroSimple] || `Habitación ${nroCompleto}`;

                return (
                  <div
                    className="selected-room-item"
                    key={`${item.fechaIngreso}-${item.nro}-${idx}`}
                  >
                    <div className="selected-room-type">
                      Tipo de habitación: {tipoHab}
                    </div>
                    <div className="selected-room-line">
                      Ingreso: {item.fechaIngreso}, 12:00 hs
                    </div>
                    <div className="selected-room-line">
                      Egreso: {item.fechaEgreso}, 10:00 hs
                    </div>
                  </div>
                );
              })
            )}
          </div>
        </section>

        {}
        <section className="datos-right-panel">
          <h2 className="section-subtitle">Reserva a nombre de</h2>

          <form
            className="datos-form"
            onSubmit={(e) => {
              e.preventDefault();
              handleConfirmar();
            }}
          >
            {/* Nombre */}
            <div className="datos-field">
              <label htmlFor="nombre" className="datos-label">
                Nombre <span className="required">*</span>
              </label>
              <input
                id="nombre"
                name="nombre"
                type="text"
                className={`input datos-input ${
                  fieldErrors.nombre ? "input-error" : ""
                }`}
                value={form.nombre}
                onChange={handleChange}
                required
              />
              {fieldErrors.nombre && (
                <p className="field-error-message">{fieldErrors.nombre}</p>
              )}
            </div>

            {/* Apellido */}
            <div className="datos-field">
              <label htmlFor="apellido" className="datos-label">
                Apellido <span className="required">*</span>
              </label>
              <input
                id="apellido"
                name="apellido"
                type="text"
                className={`input datos-input ${
                  fieldErrors.apellido ? "input-error" : ""
                }`}
                value={form.apellido}
                onChange={handleChange}
                required
              />
              {fieldErrors.apellido && (
                <p className="field-error-message">{fieldErrors.apellido}</p>
              )}
            </div>

            {/* Teléfono */}
            <div className="phone-group">
              <label className="phone-label" htmlFor="telefono">
                Número Teléfono <span className="required">*</span>
              </label>

              <div className="phone-row">
                <select
                  id="prefijo"
                  name="prefijo"
                  className="phone-prefix"
                  value={form.prefijo}
                  onChange={handleChange}
                >
                  <option value="+54 9">+54 9</option>
                  <option value="+54">+54</option>
                </select>

                <input
                  id="telefono"
                  name="telefono"
                  type="text"
                  inputMode="numeric"
                  pattern="[0-9]*"
                  className={`phone-input ${
                    fieldErrors.telefono ? "input-error" : ""
                  }`}
                  value={form.telefono}
                  onChange={handleChange}
                  required
                />
              </div>

              {fieldErrors.telefono && (
                <p className="field-error-message">{fieldErrors.telefono}</p>
              )}
            </div>

            <div className="actions-row">
              <button
                type="button"
                className={`btnSecondary ${enviando ? "btnPrimaryDisabled" : ""}`}
                onClick={handleCancelar}
                disabled={enviando}
              >
                Cancelar
              </button>

              <button
                type="submit"
                className={`btnPrimary ${enviando ? "btnPrimaryDisabled" : ""}`}
                disabled={enviando}
              >
                {enviando ? "Confirmando..." : "Confirmar"}
              </button>
            </div>

            {error && <p className="error-text">{error}</p>}
          </form>
        </section>
      </main>

      {/* -------- POP-UP RESERVA EXITOSA -------- */}
      {showSuccessModal && (
        <div className="popup-overlay">
          <div className="popup-card">
            <h3 className="popup-title">Reserva exitosa</h3>

            <p className="popup-message">
              La reserva se registró correctamente.
            </p>

            <div className="popup-actions">
              <button
                type="button"
                className="primary-button primary-button-strong"
                onClick={handleCerrarModalExito}
              >
                OK
              </button>
            </div>
          </div>
        </div>
      )}

      {showCamposObligatoriosPopup && (
        <div className="modalOverlayReservaError">
          <div className="modalContentErrorReserva">
            <div className="modalTitleErrorReserva">
              campo obligatorio incompleto
            </div>
            <div className="modalBodyErrorReserva">
              Por favor, completá todos los campos requeridos antes de continuar.
            </div>
            <div className="modalButtonsErrorReserva">
              <button
                type="button"
                className="modalButtonBase modalButtonErrorReserva"
                onClick={() => setShowCamposObligatoriosPopup(false)}
              >
                Cerrar
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default DatosReservaPage;





